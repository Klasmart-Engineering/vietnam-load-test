<html>
  <head>
    <meta charset="utf-8" />
    <title>Import webrtc-internals dumps</title>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <!-- highcharts is used under the terms of
            http://shop.highsoft.com/faq/non-commercial
        -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
      "use strict";const SDPUtils={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};SDPUtils.localCName=SDPUtils.generateIdentifier(),SDPUtils.splitLines=function(t){return t.trim().split("\n").map(t=>t.trim())},SDPUtils.splitSections=function(t){return t.split("\nm=").map((t,e)=>(e>0?"m="+t:t).trim()+"\r\n")},SDPUtils.getDescription=function(t){const e=SDPUtils.splitSections(t);return e&&e[0]},SDPUtils.getMediaSections=function(t){const e=SDPUtils.splitSections(t);return e.shift(),e},SDPUtils.matchPrefix=function(t,e){return SDPUtils.splitLines(t).filter(t=>0===t.indexOf(e))},SDPUtils.parseCandidate=function(t){let e;const r={foundation:(e=0===t.indexOf("a=candidate:")?t.substring(12).split(" "):t.substring(10).split(" "))[0],component:{1:"rtp",2:"rtcp"}[e[1]]||e[1],protocol:e[2].toLowerCase(),priority:parseInt(e[3],10),ip:e[4],address:e[4],port:parseInt(e[5],10),type:e[7]};for(let t=8;t<e.length;t+=2)switch(e[t]){case"raddr":r.relatedAddress=e[t+1];break;case"rport":r.relatedPort=parseInt(e[t+1],10);break;case"tcptype":r.tcpType=e[t+1];break;case"ufrag":r.ufrag=e[t+1],r.usernameFragment=e[t+1];break;default:void 0===r[e[t]]&&(r[e[t]]=e[t+1])}return r},SDPUtils.writeCandidate=function(t){const e=[];e.push(t.foundation);const r=t.component;"rtp"===r?e.push(1):"rtcp"===r?e.push(2):e.push(r),e.push(t.protocol.toUpperCase()),e.push(t.priority),e.push(t.address||t.ip),e.push(t.port);const s=t.type;return e.push("typ"),e.push(s),"host"!==s&&t.relatedAddress&&t.relatedPort&&(e.push("raddr"),e.push(t.relatedAddress),e.push("rport"),e.push(t.relatedPort)),t.tcpType&&"tcp"===t.protocol.toLowerCase()&&(e.push("tcptype"),e.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(e.push("ufrag"),e.push(t.usernameFragment||t.ufrag)),"candidate:"+e.join(" ")},SDPUtils.parseIceOptions=function(t){return t.substr(14).split(" ")},SDPUtils.parseRtpMap=function(t){let e=t.substr(9).split(" ");const r={payloadType:parseInt(e.shift(),10)};return e=e[0].split("/"),r.name=e[0],r.clockRate=parseInt(e[1],10),r.channels=3===e.length?parseInt(e[2],10):1,r.numChannels=r.channels,r},SDPUtils.writeRtpMap=function(t){let e=t.payloadType;void 0!==t.preferredPayloadType&&(e=t.preferredPayloadType);const r=t.channels||t.numChannels||1;return"a=rtpmap:"+e+" "+t.name+"/"+t.clockRate+(1!==r?"/"+r:"")+"\r\n"},SDPUtils.parseExtmap=function(t){const e=t.substr(9).split(" ");return{id:parseInt(e[0],10),direction:e[0].indexOf("/")>0?e[0].split("/")[1]:"sendrecv",uri:e[1]}},SDPUtils.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&"sendrecv"!==t.direction?"/"+t.direction:"")+" "+t.uri+"\r\n"},SDPUtils.parseFmtp=function(t){const e={};let r;const s=t.substr(t.indexOf(" ")+1).split(";");for(let t=0;t<s.length;t++)e[(r=s[t].trim().split("="))[0].trim()]=r[1];return e},SDPUtils.writeFmtp=function(t){let e="",r=t.payloadType;if(void 0!==t.preferredPayloadType&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const s=[];Object.keys(t.parameters).forEach(e=>{t.parameters[e]?s.push(e+"="+t.parameters[e]):s.push(e)}),e+="a=fmtp:"+r+" "+s.join(";")+"\r\n"}return e},SDPUtils.parseRtcpFb=function(t){const e=t.substr(t.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}},SDPUtils.writeRtcpFb=function(t){let e="",r=t.payloadType;return void 0!==t.preferredPayloadType&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(t=>{e+="a=rtcp-fb:"+r+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"}),e},SDPUtils.parseSsrcMedia=function(t){const e=t.indexOf(" "),r={ssrc:parseInt(t.substr(7,e-7),10)},s=t.indexOf(":",e);return s>-1?(r.attribute=t.substr(e+1,s-e-1),r.value=t.substr(s+1)):r.attribute=t.substr(e+1),r},SDPUtils.parseSsrcGroup=function(t){const e=t.substr(13).split(" ");return{semantics:e.shift(),ssrcs:e.map(t=>parseInt(t,10))}},SDPUtils.getMid=function(t){const e=SDPUtils.matchPrefix(t,"a=mid:")[0];if(e)return e.substr(6)},SDPUtils.parseFingerprint=function(t){const e=t.substr(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1].toUpperCase()}},SDPUtils.getDtlsParameters=function(t,e){return{role:"auto",fingerprints:SDPUtils.matchPrefix(t+e,"a=fingerprint:").map(SDPUtils.parseFingerprint)}},SDPUtils.writeDtlsParameters=function(t,e){let r="a=setup:"+e+"\r\n";return t.fingerprints.forEach(t=>{r+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"}),r},SDPUtils.parseCryptoLine=function(t){const e=t.substr(9).split(" ");return{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}},SDPUtils.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+("object"==typeof t.keyParams?SDPUtils.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+"\r\n"},SDPUtils.parseCryptoKeyParams=function(t){if(0!==t.indexOf("inline:"))return null;const e=t.substr(7).split("|");return{keyMethod:"inline",keySalt:e[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:void 0,mkiLength:e[2]?e[2].split(":")[1]:void 0}},SDPUtils.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},SDPUtils.getCryptoParameters=function(t,e){return SDPUtils.matchPrefix(t+e,"a=crypto:").map(SDPUtils.parseCryptoLine)},SDPUtils.getIceParameters=function(t,e){const r=SDPUtils.matchPrefix(t+e,"a=ice-ufrag:")[0],s=SDPUtils.matchPrefix(t+e,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substr(12),password:s.substr(10)}:null},SDPUtils.writeIceParameters=function(t){let e="a=ice-ufrag:"+t.usernameFragment+"\r\na=ice-pwd:"+t.password+"\r\n";return t.iceLite&&(e+="a=ice-lite\r\n"),e},SDPUtils.parseRtpParameters=function(t){const e={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=SDPUtils.splitLines(t)[0].split(" ");for(let s=3;s<r.length;s++){const i=r[s],n=SDPUtils.matchPrefix(t,"a=rtpmap:"+i+" ")[0];if(n){const r=SDPUtils.parseRtpMap(n),s=SDPUtils.matchPrefix(t,"a=fmtp:"+i+" ");switch(r.parameters=s.length?SDPUtils.parseFmtp(s[0]):{},r.rtcpFeedback=SDPUtils.matchPrefix(t,"a=rtcp-fb:"+i+" ").map(SDPUtils.parseRtcpFb),e.codecs.push(r),r.name.toUpperCase()){case"RED":case"ULPFEC":e.fecMechanisms.push(r.name.toUpperCase())}}}return SDPUtils.matchPrefix(t,"a=extmap:").forEach(t=>{e.headerExtensions.push(SDPUtils.parseExtmap(t))}),e},SDPUtils.writeRtpDescription=function(t,e){let r="";r+="m="+t+" ",r+=e.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=e.codecs.map(t=>void 0!==t.preferredPayloadType?t.preferredPayloadType:t.payloadType).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",e.codecs.forEach(t=>{r+=SDPUtils.writeRtpMap(t),r+=SDPUtils.writeFmtp(t),r+=SDPUtils.writeRtcpFb(t)});let s=0;return e.codecs.forEach(t=>{t.maxptime>s&&(s=t.maxptime)}),s>0&&(r+="a=maxptime:"+s+"\r\n"),e.headerExtensions&&e.headerExtensions.forEach(t=>{r+=SDPUtils.writeExtmap(t)}),r},SDPUtils.parseRtpEncodingParameters=function(t){const e=[],r=SDPUtils.parseRtpParameters(t),s=-1!==r.fecMechanisms.indexOf("RED"),i=-1!==r.fecMechanisms.indexOf("ULPFEC"),n=SDPUtils.matchPrefix(t,"a=ssrc:").map(t=>SDPUtils.parseSsrcMedia(t)).filter(t=>"cname"===t.attribute),a=n.length>0&&n[0].ssrc;let p;const c=SDPUtils.matchPrefix(t,"a=ssrc-group:FID").map(t=>{return t.substr(17).split(" ").map(t=>parseInt(t,10))});c.length>0&&c[0].length>1&&c[0][0]===a&&(p=c[0][1]),r.codecs.forEach(t=>{if("RTX"===t.name.toUpperCase()&&t.parameters.apt){let r={ssrc:a,codecPayloadType:parseInt(t.parameters.apt,10)};a&&p&&(r.rtx={ssrc:p}),e.push(r),s&&((r=JSON.parse(JSON.stringify(r))).fec={ssrc:a,mechanism:i?"red+ulpfec":"red"},e.push(r))}}),0===e.length&&a&&e.push({ssrc:a});let o=SDPUtils.matchPrefix(t,"b=");return o.length&&(o=0===o[0].indexOf("b=TIAS:")?parseInt(o[0].substr(7),10):0===o[0].indexOf("b=AS:")?1e3*parseInt(o[0].substr(5),10)*.95-16e3:void 0,e.forEach(t=>{t.maxBitrate=o})),e},SDPUtils.parseRtcpParameters=function(t){const e={},r=SDPUtils.matchPrefix(t,"a=ssrc:").map(t=>SDPUtils.parseSsrcMedia(t)).filter(t=>"cname"===t.attribute)[0];r&&(e.cname=r.value,e.ssrc=r.ssrc);const s=SDPUtils.matchPrefix(t,"a=rtcp-rsize");e.reducedSize=s.length>0,e.compound=0===s.length;const i=SDPUtils.matchPrefix(t,"a=rtcp-mux");return e.mux=i.length>0,e},SDPUtils.writeRtcpParameters=function(t){let e="";return t.reducedSize&&(e+="a=rtcp-rsize\r\n"),t.mux&&(e+="a=rtcp-mux\r\n"),void 0!==t.ssrc&&t.cname&&(e+="a=ssrc:"+t.ssrc+" cname:"+t.cname+"\r\n"),e},SDPUtils.parseMsid=function(t){let e;const r=SDPUtils.matchPrefix(t,"a=msid:");if(1===r.length)return{stream:(e=r[0].substr(7).split(" "))[0],track:e[1]};const s=SDPUtils.matchPrefix(t,"a=ssrc:").map(t=>SDPUtils.parseSsrcMedia(t)).filter(t=>"msid"===t.attribute);return s.length>0?{stream:(e=s[0].value.split(" "))[0],track:e[1]}:void 0},SDPUtils.parseSctpDescription=function(t){const e=SDPUtils.parseMLine(t),r=SDPUtils.matchPrefix(t,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substr(19),10)),isNaN(s)&&(s=65536);const i=SDPUtils.matchPrefix(t,"a=sctp-port:");if(i.length>0)return{port:parseInt(i[0].substr(12),10),protocol:e.fmt,maxMessageSize:s};const n=SDPUtils.matchPrefix(t,"a=sctpmap:");if(n.length>0){const t=n[0].substr(10).split(" ");return{port:parseInt(t[0],10),protocol:t[1],maxMessageSize:s}}},SDPUtils.writeSctpDescription=function(t,e){let r=[];return r="DTLS/SCTP"!==t.protocol?["m="+t.kind+" 9 "+t.protocol+" "+e.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+e.port+"\r\n"]:["m="+t.kind+" 9 "+t.protocol+" "+e.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+e.port+" "+e.protocol+" 65535\r\n"],void 0!==e.maxMessageSize&&r.push("a=max-message-size:"+e.maxMessageSize+"\r\n"),r.join("")},SDPUtils.generateSessionId=function(){return Math.random().toString().substr(2,21)},SDPUtils.writeSessionBoilerplate=function(t,e,r){let s;const i=void 0!==e?e:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(s=t||SDPUtils.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},SDPUtils.getDirection=function(t,e){const r=SDPUtils.splitLines(t);for(let t=0;t<r.length;t++)switch(r[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[t].substr(2)}return e?SDPUtils.getDirection(e):"sendrecv"},SDPUtils.getKind=function(t){return SDPUtils.splitLines(t)[0].split(" ")[0].substr(2)},SDPUtils.isRejected=function(t){return"0"===t.split(" ",2)[1]},SDPUtils.parseMLine=function(t){const e=SDPUtils.splitLines(t)[0].substr(2).split(" ");return{kind:e[0],port:parseInt(e[1],10),protocol:e[2],fmt:e.slice(3).join(" ")}},SDPUtils.parseOLine=function(t){const e=SDPUtils.matchPrefix(t,"o=")[0].substr(2).split(" ");return{username:e[0],sessionId:e[1],sessionVersion:parseInt(e[2],10),netType:e[3],addressType:e[4],address:e[5]}},SDPUtils.isValidSDP=function(t){if("string"!=typeof t||0===t.length)return!1;const e=SDPUtils.splitLines(t);for(let t=0;t<e.length;t++)if(e[t].length<2||"="!==e[t].charAt(1))return!1;return!0},"object"==typeof module&&(module.exports=SDPUtils);
    </script>
    <style>
      body, body svg text {
          font-family: monospace;
      }
      details[open] pre {
          padding-left: 10px;
          padding-bottom: 10px;
      }
      table details[open] summary {
          color: blue;
      }
      table details.host summary:after {
          content: ' (host)';
      }
      table details.relay summary:after {
          content: ' (relay)';
      }
      table details.srflx summary:after {
          content: ' (srflx)'
      }

      #tables>details:nth-of-type(even) {
          background-color: #f0f0f0;
      }

      .graph {
          margin-left: 10px;
          margin-right: 10px;
      }

      .candidatepairtable {
          text-align: center;
      }
      .candidatepairtable td {
          background-color: #ddd;
          padding: 5px;
      }
      ice.style['background-color'] = '#ddd';
      ice.style['text-align'] = 'center';

      button.copyBtn {
          border: 0px;
      }
    </style>

    <script>
      function createLegacyCandidateTable(container, stun) {
        // for ice candidates
        var head = document.createElement('tr');

        var el;
        el = document.createElement('td');
        el.innerText = 'Local address';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Local type';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Local id';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Remote address';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Remote type';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Remote id';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Requests sent';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Responses received';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Requests received';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Responses sent';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Active Connection';
        head.appendChild(el);
        container.appendChild(head);

        for (t in stun) {
          var row = document.createElement('tr');

          el = document.createElement('td');
          el.innerText = stun[t].googLocalAddress;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].googLocalCandidateType;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].localCandidateId;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].googRemoteAddress;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].googRemoteCandidateType;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].remoteCandidateId;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].requestsSent;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].responsesReceived;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].requestsReceived;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].responsesSent;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = stun[t].googActiveConnection;
          row.appendChild(el);
          /*
        el = document.createElement('td');
        el.innerText = stun[t].consentRequestsSent;
        row.appendChild(el);
        */

          container.appendChild(row);
        }
      }

      function createSpecCandidateTable(container, allStats) {
        var head = document.createElement('tr');

        let el;
        el = document.createElement('td');
        el.innerText = 'Transport id';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Candidate pair id';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'Candidate id';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = ''; // local/remote, leave empty.
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'type';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'address';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'port';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'protocol';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'priority';
        head.appendChild(el);

        el = document.createElement('td');
        el.innerText = 'interface';
        head.appendChild(el);

        container.appendChild(head);

        const transports = {};
        const pairs = {};
        const candidates = {};
        let row;
        for (reportname in allStats) {
          t = reportname.split('-');
          comp = t.pop();
          t = t.join('-');
          const stats = JSON.parse(allStats[reportname].values);
          if (reportname.indexOf('RTCTransport') === 0) {
            if (!transports[t]) transports[t] = {};
            switch (comp) {
              case 'bytesSent':
              case 'bytesReceived':
              case 'dtlsState':
              case 'selectedCandidatePairId':
                transports[t][comp] = stats[stats.length - 1];
              default:
              // console.log(reportname, comp, stats);
            }
          } else if (reportname.indexOf('RTCIceCandidatePair') === 0) {
            if (!pairs[t]) pairs[t] = {};
            pairs[t][comp] = stats[stats.length - 1];
          } else if (reportname.indexOf('RTCIceCandidate') === 0) {
            if (!candidates[t]) candidates[t] = {};
            candidates[t][comp] = stats[stats.length - 1];
          }
        }
        for (t in transports) {
          row = document.createElement('tr');

          el = document.createElement('td');
          el.innerText = t;
          row.appendChild(el);

          el = document.createElement('td');
          el.innerText = transports[t].selectedCandidatePairId;
          row.appendChild(el);

          container.appendChild(row);

          for (p in pairs) {
            if (pairs[p].transportId !== t) continue;
            const pair = pairs[p];
            row = document.createElement('tr');

            row.appendChild(document.createElement('td'));

            el = document.createElement('td');
            el.innerText = p;
            row.appendChild(el);

            container.appendChild(row);
            // console.log('PAIR', p, pair);

            for (c in candidates) {
              if (
                !(c === pair.localCandidateId || c === pair.remoteCandidateId)
              )
                continue;
              const candidate = candidates[c];
              row = document.createElement('tr');

              row.appendChild(document.createElement('td'));
              row.appendChild(document.createElement('td'));
              el = document.createElement('td');
              el.innerText = c;
              row.appendChild(el);

              el = document.createElement('td');
              el.innerText = candidate.isRemote ? 'remote' : 'local';
              row.appendChild(el);

              el = document.createElement('td');
              el.innerText = candidate.candidateType;
              row.appendChild(el);

              el = document.createElement('td');
              el.innerText = candidate.address || candidate.ip;
              row.appendChild(el);

              el = document.createElement('td');
              el.innerText = candidate.port;
              row.appendChild(el);

              el = document.createElement('td');
              el.innerText = candidate.protocol;
              row.appendChild(el);

              el = document.createElement('td');
              el.innerText = candidate.priority;
              row.appendChild(el);

              el = document.createElement('td');
              el.innerText = candidate.networkType || 'unknown';
              row.appendChild(el);

              container.appendChild(row);
            }
          }
        }
      }

      function createContainers(connid, url) {
        var el;
        var container = document.createElement('details');
        container.open = true;
        container.style.margin = '10px';

        var summary = document.createElement('summary');
        summary.innerText = 'Connection:' + connid + ' URL: ' + url;
        container.appendChild(summary);

        var configuration = document.createElement('div');
        container.appendChild(configuration);

        // show state transitions, like in https://webrtc.github.io/samples/src/content/peerconnection/states
        var signalingState = document.createElement('div');
        signalingState.id = 'signalingstate_' + connid;
        signalingState.textContent = 'Signaling state:';
        container.appendChild(signalingState);
        var iceConnectionState = document.createElement('div');
        iceConnectionState.id = 'iceconnectionstate_' + connid;
        iceConnectionState.textContent = 'ICE connection state:';
        container.appendChild(iceConnectionState);

        var connectionState = document.createElement('div');
        connectionState.id = 'connectionstate_' + connid;
        connectionState.textContent = 'Connection state:';
        container.appendChild(connectionState);

        var candidates = document.createElement('table');
        candidates.className = 'candidatepairtable';
        container.appendChild(candidates);

        var updateLog = document.createElement('table');
        head = document.createElement('tr');
        updateLog.appendChild(head);

        el = document.createElement('th');
        el.innerText = 'connection ' + connid;
        head.appendChild(el);

        el = document.createElement('th');
        head.appendChild(el);

        container.appendChild(updateLog);

        var graphs = document.createElement('div');
        container.appendChild(graphs);

        containers[connid] = {
          updateLog,
          iceConnectionState,
          connectionState,
          signalingState,
          candidates,
          url,
          configuration,
          graphs,
        };

        return container;
      }

      function processGUM(data) {
        var container = document.createElement('details');
        container.open = true;
        container.style.margin = '10px';

        var summary = document.createElement('summary');
        summary.innerText = 'getUserMedia calls';
        container.appendChild(summary);

        var table = document.createElement('table');
        var head = document.createElement('tr');
        table.appendChild(head);

        container.appendChild(table);

        var columns = [
          'request_id',
          'origin',
          'pid',
          'rid',
          'audio',
          'video',
          'audio_track_info',
          'video_track_info',
          'error',
          'error_message',
        ];
        var displayNames = {
          audio: 'audio constraints',
          video: 'video constraints',
          audio_track_info: 'audio track',
          video_track_info: 'video track',
          error_message: 'error message',
        };
        columns.forEach(function (name) {
          var el;
          el = document.createElement('th');
          el.innerText = displayNames[name] || name;
          head.appendChild(el);
        });

        document.getElementById('tables').appendChild(container);
        data.forEach(function (event) {
          var id = ['gum-row', event.pid, event.rid, event.request_id].join(
            '-'
          );
          if (!event.origin) {
            // Not a getUserMedia call back a response.
            const existingRow = document.getElementById(id);
            if (event.error) {
              existingRow.childNodes[8].innerText = event.error;
              existingRow.childNodes[9].innerText = event.error_message;
            } else if (event.audio_track_info) {
              existingRow.childNodes[6].innerText = event.audio_track_info;
            } else if (event.video_track_info) {
              existingRow.childNodes[7].innerText = event.video_track_info;
            }
            return;
          }
          var row = document.createElement('tr');
          row.id = id;
          columns.forEach(function (attribute) {
            var cell = document.createElement('td');
            // getUserMedia request.
            if (['audio', 'video'].includes(attribute)) {
              cell.innerText = event.hasOwnProperty(attribute)
                ? event[attribute] || 'true'
                : 'not set';
            } else {
              cell.innerText = event.hasOwnProperty(attribute)
                ? event[attribute]
                : '';
            }
            row.appendChild(cell);
          });
          table.appendChild(row);
        });
      }

      function processTraceEvent(table, event) {
        var row = document.createElement('tr');
        var el = document.createElement('td');
        el.setAttribute('nowrap', '');
        el.innerText = event.time;
        row.appendChild(el);

        // recreate the HTML of webrtc-internals
        var details = document.createElement('details');
        el = document.createElement('summary');
        el.innerText = event.type;
        details.appendChild(el);
        if (event.value.indexOf(', sdp: ') != -1) {
          const [type, sdp] = event.value.substr(6).split(', sdp: ');
          const sections = SDPUtils.splitSections(sdp);

          el.innerText +=
            ' (type: "' + type + '", ' + sections.length + ' sections)';
          const copyBtn = document.createElement('button');
          copyBtn.innerText = '\uD83D\uDCCB'; // clipboard
          copyBtn.className = 'copyBtn';
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(JSON.stringify({ type, sdp }));
          };
          el.appendChild(copyBtn);

          el = document.createElement('pre');
          sections.forEach((section) => {
            const lines = SDPUtils.splitLines(section);
            const mid = lines
              .filter((line) => line.startsWith('a=mid:'))
              .map((line) => line.substr(6))[0];

            const details = document.createElement('details');
            // Fold by default for large SDP.
            details.open = sections.length < 10;
            details.innerText = section;

            const summary = document.createElement('summary');
            summary.innerText =
              lines[0] +
              ' (' +
              (lines.length - 1) +
              ' more lines)' +
              (mid ? ' mid=' + mid : '');
            details.appendChild(summary);
            el.appendChild(details);
          });
        } else {
          el = document.createElement('pre');
          el.innerText = event.value;
        }
        details.appendChild(el);
        el = document.createElement('td');
        el.appendChild(details);

        row.appendChild(el);

        // guess what, if the event type contains 'Failure' one could use css to highlight it
        if (event.type.indexOf('Failure') !== -1) {
          row.style.backgroundColor = 'red';
        }

        if (
          event.type === 'iceconnectionstatechange' ||
          event.type === 'connectionstatechange'
        ) {
          switch (event.value) {
            case 'connected':
            case 'completed':
              row.style.backgroundColor = 'green';
              break;
            case 'failed':
              row.style.backgroundColor = 'red';
              break;
          }
        } else if (event.type === 'iceConnectionStateChange') {
          // Legacy variant, probably broken by now since the values changed.
          switch (event.value) {
            case 'ICEConnectionStateConnected':
            case 'ICEConnectionStateCompleted':
            case 'kICEConnectionStateConnected':
            case 'kICEConnectionStateCompleted':
              row.style.backgroundColor = 'green';
              break;
            case 'ICEConnectionStateFailed':
            case 'kICEConnectionStateFailed':
              row.style.backgroundColor = 'red';
              break;
          }
        }

        if (event.type === 'icecandidate' || event.type === 'addIceCandidate') {
          if (event.value && event.value.candidate) {
            var parts = event.value.split(',')[2].trim().split(' ');
            if (parts && parts.length >= 9 && parts[7] === 'typ') {
              details.classList.add(parts[8]);
            }
          }
        } else if (
          event.type === 'onIceCandidate' ||
          event.type === 'addIceCandidate'
        ) {
          // Legacy variant.
          if (event.value && event.value.candidate) {
            var parts = event.value.split(',')[2].trim().split(' ');
            if (parts && parts.length >= 9 && parts[7] === 'typ') {
              details.classList.add(parts[8]);
            }
          }
        }
        table.appendChild(row);
      }

      var graphs = {};
      var containers = {};
      function importUpdatesAndStats(data) {
        document.getElementById('userAgent').innerText = data.UserAgent;

        var connection;
        var connid, reportname, stat;
        var t, comp;
        var stats;

        // FIXME: also display GUM calls (can they be correlated to addStream?)
        processGUM(data.getUserMedia);

        // first, display the updateLog
        for (connid in data.PeerConnections) {
          var connection = data.PeerConnections[connid];
          var container = createContainers(connid, connection.url);

          containers[connid].url.innerText = 'Origin: ' + connection.url;
          containers[connid].configuration.innerText =
            'Configuration: ' +
            JSON.stringify(connection.rtcConfiguration, null, ' ') +
            '\n';
          containers[connid].configuration.innerText +=
            'Legacy (chrome) constraints: ' +
            JSON.stringify(connection.constraints, null, ' ');

          document.getElementById('tables').appendChild(container);

          connection.updateLog.forEach(function (event) {
            processTraceEvent(containers[connid].updateLog, event);
          });
          connection.updateLog.forEach(function (event) {
            // update state displays
            if (event.type === 'iceConnectionStateChange') {
              containers[connid].iceConnectionState.textContent +=
                ' => ' + event.value;
            }
            if (event.type === 'connectionStateChange') {
              containers[connid].connectionState.textContent +=
                ' => ' + event.value;
            }
          });
          connection.updateLog.forEach(function (event) {
            // FIXME: would be cool if a click on this would jump to the table row
            if (event.type === 'signalingStateChange') {
              containers[connid].signalingState.textContent +=
                ' => ' + event.value;
            }
          });
          var stun = {};
          for (reportname in connection.stats) {
            if (reportname.indexOf('Conn-') === 0) {
              t = reportname.split('-');
              comp = t.pop();
              t = t.join('-');
              if (!stun[t]) stun[t] = {};
              stats = JSON.parse(connection.stats[reportname].values);
              switch (comp) {
                case 'requestsSent':
                case 'consentRequestsSent':
                case 'responsesSent':
                case 'requestsReceived':
                case 'responsesReceived':
                case 'localCandidateId':
                case 'remoteCandidateId':
                case 'googLocalAddress':
                case 'googRemoteAddress':
                case 'googLocalCandidateType':
                case 'googRemoteCandidateType':
                case 'googActiveConnection':
                  //console.log(t, comp, connection.stats[reportname]);
                  stun[t][comp] = stats[stats.length - 1];
                  break;
                default:
                //console.log(reportname, comp, stats);
              }
            }
          }

          if (Object.keys(stun).length === 0) {
            createSpecCandidateTable(
              containers[connid].candidates,
              connection.stats
            );
            // spec-stats. A bit more complicated... we need the transport and then the candidate pair and the local/remote candidates.
          } else {
            createLegacyCandidateTable(containers[connid].candidates, stun);
          }
        }
        // then, update the stats displays
        processConnections(Object.keys(data.PeerConnections), data);
      }

      function processConnections(connectionIds, data) {
        var connid = connectionIds.shift();
        if (!connid) return;
        window.setTimeout(processConnections, 0, connectionIds, data);

        var connection = data.PeerConnections[connid];
        graphs[connid] = {};
        var reportobj = {};
        var values;
        for (reportname in connection.stats) {
          // special casing of computed stats, in particular [a-b]
          if (reportname.indexOf('[') !== -1) {
            t = reportname.split('[');
            comp = '[' + t.pop();
            stat = t.join('');
            stat = stat.substr(0, stat.length - 1);
          } else {
            t = reportname.split('-');
            comp = t.pop();
            stat = t.join('-');
          }

          if (!reportobj.hasOwnProperty(stat)) {
            reportobj[stat] = [];
          }
          values = JSON.parse(connection.stats[reportname].values);
          startTime = new Date(
            connection.stats[reportname].startTime
          ).getTime();
          endTime = new Date(connection.stats[reportname].endTime).getTime();
          values = values.map(function (currentValue, index) {
            return [startTime + 1000 * index, currentValue];
          });
          reportobj[stat].push([comp, values]);
        }

        // sort so we get a more useful order of graphs:
        // * ssrcs
        // * bwe
        // * everything else alphabetically
        var names = Object.keys(reportobj);
        var ssrcs = names
          .filter(function (name) {
            return name.indexOf('ssrc_') === 0;
          })
          .sort(function (a, b) {
            // sort by send/recv and ssrc
            var aParts = a.split('_');
            var bParts = b.split('_');
            if (aParts[2] === bParts[2]) {
              return parseInt(aParts[1], 10) - parseInt(bParts[1], 10);
            } else if (aParts[2] === 'send') return -1;
            return 1;
          });
        var bwe = names.filter(function (name) {
          return name === 'bweforvideo';
        });
        names = names.filter(function (name) {
          return name.indexOf('ssrc_') === -1 && name !== 'bweforvideo';
        });
        names = ssrcs.concat(bwe, names);
        names.forEach(function (reportname) {
          // ignore useless graphs
          if (
            reportname.indexOf('Cand-') === 0 ||
            reportname.indexOf('Channel') === 0
          )
            return;
          if (reportname.indexOf('RTCCodec_') === 0) return;

          var series = [];
          var reports = reportobj[reportname];
          reports.sort().forEach(function (report) {
            if (report[0] === 'mediaType' || report[0] === 'kind') {
              series.mediaType = report[1][0][1];
            }
            if (report[0] === 'googTrackId') {
              series.trackId = report[1][0][1];
            }
            if (report[0] === 'ssrc') {
              series.ssrc = report[1][0][1];
            }
            if (typeof report[1][0][1] !== 'number') return;
            if (report[0] === 'bytesReceived' || report[0] === 'bytesSent')
              return;
            if (
              report[0] === 'headerBytesReceived' ||
              report[0] === 'headerBytesSent'
            )
              return;
            if (report[0] === 'packetsReceived' || report[0] === 'packetsSent')
              return;
            if (report[0] === 'googCaptureStartNtpTimeMs') return;

            if (
              report[0] === 'bitsReceivedPerSecond' ||
              report[0] === 'bitsSentPerSecond'
            ) {
              // convert to kbps
              report[0] = 'k' + report[0];
              report[1] = report[1].map(function (el) {
                return [el[0], Math.floor(el[1] / 1000)];
              });
            }

            var hiddenSeries = [
              'qpSum',
              'estimatedPlayoutTimestamp',
              'framesEncoded',
              'framesDecoded',
              'lastPacketReceivedTimestamp',
              'audioInputLevel',
              'audioOutputLevel',
              'googEchoCancellationEchoDelayStdDev',
              'totalSamplesDuration',
              'googDecodingCTN',
              'googDecodingCNG',
              'googDecodingNormal',
              'googDecodingPLCCNG',
              'googDecodingCTSG',
              'googDecodingMuted',
              'priority',
              'port',
            ];

            series.push({
              name: report[0],
              visible: hiddenSeries.indexOf(report[0]) === -1,
              data: report[1],
            });
          });
          if (series.length > 0) {
            var container = document.createElement('details');
            container.open =
              reportname.indexOf('ssrc_') === 0 ||
              reportname === 'bweforvideo' ||
              (reportname.indexOf('Conn-') === 0 &&
                reportname.indexOf('-1-0') !== -1);
            containers[connid].graphs.appendChild(container);
            //document.getElementById('container').appendChild(container);

            var title =
              (series.mediaType ? 'media kind=' + series.mediaType + ' ' : '') +
              (series.ssrc ? 'ssrc=' + series.ssrc.toString(16) + ' ' : '') +
              (series.trackId ? 'trackId=' + series.trackId + ' ' : '') +
              reportname +
              ' ';
            var titleElement = document.createElement('summary');
            titleElement.innerText = title;
            container.appendChild(titleElement);

            var d = document.createElement('div');
            d.id = 'chart_' + Date.now();
            d.classList.add('graph');
            container.appendChild(d);
            var graph = new Highcharts.Chart({
              title: {
                text: null,
              },
              xAxis: {
                type: 'datetime',
              },
              yAxis: {
                min: series.mediaType ? 0 : undefined,
              },
              chart: {
                zoomType: 'x',
                renderTo: d.id,
              },
              series: series,
            });
            graphs[connid][reportname] = graph;

            // expand the graph when opening
            container.ontoggle = () => container.open && graph.reflow();

            // draw checkbox to turn off everything
            ((reportname, container, graph) => {
              var checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              container.appendChild(checkbox);
              var label = document.createElement('label');
              label.innerText = 'Turn on/off all data series';
              container.appendChild(label);
              checkbox.onchange = function () {
                graph.series.forEach(function (series) {
                  series.setVisible(!checkbox.checked, false);
                });
                graph.redraw();
              };
            })(reportname, container, graph);
          }
        });
      }

      //Custom import function
      function doImport(file) {
        var rawFile = new XMLHttpRequest();
        rawFile.open('GET', file, false);
        rawFile.onreadystatechange = function () {
          if (rawFile.readyState === 4) {
            if (rawFile.status === 200 || rawFile.status == 0) {
              const allText = rawFile.responseText;
              const thelog = JSON.parse(allText);
              importUpdatesAndStats(thelog);
            }
          }
        };
        rawFile.send(null);
      }

      window.addEventListener('load', function () {
        doImport('webrtc_internals_dump.txt');
      });
    </script>
  </head>
  <body>
    <p>
      This is an import tool for dumps from chrome://webrtc-internals. See
      <a href="http://testrtc.com/webrtc-internals-parameters/"
        >this blog post</a
      >
      for a lengthy description of what it does and how to interpret some of the
      data.
    </p>
    <div><b>User Agent:</b> <span id="userAgent"></span></div>
    <div id="tables"></div>
  </body>
</html>
